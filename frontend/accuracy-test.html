<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Analysis Accuracy Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .test-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="number"],
        input[type="text"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .comparison-table tr:hover {
            background: #f8f9fa;
        }

        .accuracy-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .accuracy-excellent {
            background: #d4edda;
            color: #155724;
        }

        .accuracy-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .accuracy-moderate {
            background: #fff3cd;
            color: #856404;
        }

        .accuracy-poor {
            background: #f8d7da;
            color: #721c24;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .metric-label {
            font-weight: 600;
            color: #555;
        }

        .metric-value {
            color: #333;
            font-weight: bold;
        }

        .error-diff {
            color: #dc3545;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .test-history {
            margin-top: 30px;
        }

        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .confidence-meter {
            width: 100%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Voice Analysis Accuracy Tester</h1>
        <p class="subtitle">Test and validate the accuracy of voice analysis predictions</p>

        <!-- Test Input Section -->
        <div class="test-section">
            <h2 style="margin-bottom: 20px;">üìù Enter Ground Truth Data</h2>
            
            <div class="form-group">
                <label for="audioFile">Upload Audio File:</label>
                <input type="file" id="audioFile" accept="audio/*">
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <div class="form-group">
                    <label for="actualAge">Actual Age:</label>
                    <input type="number" id="actualAge" placeholder="Enter actual age" min="1" max="100">
                </div>

                <div class="form-group">
                    <label for="actualGender">Actual Gender:</label>
                    <select id="actualGender">
                        <option value="">Select gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="unknown">Other/Unknown</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="actualEmotion">Actual Emotion:</label>
                    <select id="actualEmotion">
                        <option value="">Select emotion</option>
                        <option value="happy">Happy</option>
                        <option value="sad">Sad</option>
                        <option value="angry">Angry</option>
                        <option value="neutral">Neutral</option>
                        <option value="fearful">Fearful</option>
                        <option value="surprised">Surprised</option>
                        <option value="disgusted">Disgusted</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="actualStress">Actual Stress Level (0-100):</label>
                    <input type="number" id="actualStress" placeholder="Estimated stress level" min="0" max="100">
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="runTest()">üöÄ Run Analysis Test</button>
                <button class="btn btn-secondary" onclick="clearHistory()">üóëÔ∏è Clear History</button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" style="display: none;" class="loading">
            <div class="spinner"></div>
            <p>Analyzing audio...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <h2 style="margin: 30px 0 20px 0;">üìä Analysis Results</h2>
            
            <div class="results-grid">
                <div class="result-card">
                    <h3>Age Estimation</h3>
                    <div class="metric-row">
                        <span class="metric-label">Actual Age:</span>
                        <span class="metric-value" id="actualAgeDisplay">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Predicted Age:</span>
                        <span class="metric-value" id="predictedAge">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Error:</span>
                        <span class="metric-value error-diff" id="ageError">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Confidence:</span>
                        <span class="metric-value" id="ageConfidence">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Detected Gender:</span>
                        <span class="metric-value" id="detectedGender">-</span>
                    </div>
                    <div class="confidence-meter">
                        <div class="confidence-fill" id="ageConfidenceMeter"></div>
                    </div>
                </div>

                <div class="result-card">
                    <h3>Emotion Detection</h3>
                    <div class="metric-row">
                        <span class="metric-label">Actual Emotion:</span>
                        <span class="metric-value" id="actualEmotionDisplay">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Predicted Emotion:</span>
                        <span class="metric-value" id="predictedEmotion">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Match:</span>
                        <span class="metric-value" id="emotionMatch">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Confidence:</span>
                        <span class="metric-value" id="emotionConfidence">-</span>
                    </div>
                </div>

                <div class="result-card">
                    <h3>Stress Level</h3>
                    <div class="metric-row">
                        <span class="metric-label">Actual Stress:</span>
                        <span class="metric-value" id="actualStressDisplay">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Predicted Stress:</span>
                        <span class="metric-value" id="predictedStress">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Error:</span>
                        <span class="metric-value error-diff" id="stressError">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Category:</span>
                        <span class="metric-value" id="stressCategory">-</span>
                    </div>
                </div>

                <div class="result-card">
                    <h3>Overall Accuracy</h3>
                    <div class="metric-row">
                        <span class="metric-label">Age Accuracy:</span>
                        <span class="accuracy-badge" id="ageAccuracy">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Emotion Match:</span>
                        <span class="accuracy-badge" id="emotionAccuracy">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Stress Accuracy:</span>
                        <span class="accuracy-badge" id="stressAccuracy">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test History -->
        <div id="testHistory" class="test-history" style="display: none;">
            <h2>üìú Test History</h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let testHistory = [];

        async function runTest() {
            const audioFile = document.getElementById('audioFile').files[0];
            const actualAge = parseInt(document.getElementById('actualAge').value);
            const actualGender = document.getElementById('actualGender').value;
            const actualEmotion = document.getElementById('actualEmotion').value;
            const actualStress = parseInt(document.getElementById('actualStress').value);

            if (!audioFile) {
                alert('Please upload an audio file');
                return;
            }

            if (!actualAge || !actualGender || !actualEmotion) {
                alert('Please fill in all ground truth fields');
                return;
            }

            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            try {
                // Send to API
                const formData = new FormData();
                formData.append('audio', audioFile);

                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Analysis failed');
                }

                const result = await response.json();
                const data = result.data;

                // Calculate accuracies
                const ageError = Math.abs(data.voice_age - actualAge);
                const emotionMatch = data.emotion.toLowerCase() === actualEmotion.toLowerCase();
                const stressError = actualStress ? Math.abs(data.stress_level - actualStress) : null;

                // Display results
                displayResults(data, {
                    actualAge,
                    actualGender,
                    actualEmotion,
                    actualStress,
                    ageError,
                    emotionMatch,
                    stressError
                });

                // Add to history
                addToHistory({
                    timestamp: new Date().toLocaleString(),
                    filename: audioFile.name,
                    actualAge,
                    predictedAge: data.voice_age,
                    ageError,
                    emotionMatch,
                    ageConfidence: data.age_confidence
                });

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function displayResults(data, ground_truth) {
            document.getElementById('resultsSection').style.display = 'block';

            // Age
            document.getElementById('actualAgeDisplay').textContent = ground_truth.actualAge;
            document.getElementById('predictedAge').textContent = data.voice_age;
            document.getElementById('ageError').textContent = `¬±${ground_truth.ageError} years`;
            document.getElementById('ageConfidence').textContent = `${(data.age_confidence * 100).toFixed(0)}%`;
            document.getElementById('detectedGender').textContent = data.detected_gender || 'unknown';
            document.getElementById('ageConfidenceMeter').style.width = `${data.age_confidence * 100}%`;

            // Emotion
            document.getElementById('actualEmotionDisplay').textContent = ground_truth.actualEmotion;
            document.getElementById('predictedEmotion').textContent = data.emotion;
            document.getElementById('emotionMatch').textContent = ground_truth.emotionMatch ? '‚úÖ Match' : '‚ùå Mismatch';
            document.getElementById('emotionConfidence').textContent = data.raw?.emotion?.confidence ? `${data.raw.emotion.confidence}%` : 'N/A';

            // Stress
            document.getElementById('actualStressDisplay').textContent = ground_truth.actualStress || 'Not provided';
            document.getElementById('predictedStress').textContent = data.stress_level.toFixed(1);
            document.getElementById('stressError').textContent = ground_truth.stressError ? `¬±${ground_truth.stressError.toFixed(1)}` : 'N/A';
            document.getElementById('stressCategory').textContent = data.stress_level_category || 'N/A';

            // Accuracy badges
            const ageAccuracyClass = ground_truth.ageError < 5 ? 'accuracy-excellent' :
                                     ground_truth.ageError < 10 ? 'accuracy-good' :
                                     ground_truth.ageError < 15 ? 'accuracy-moderate' : 'accuracy-poor';
            const ageAccuracyText = ground_truth.ageError < 5 ? 'Excellent' :
                                    ground_truth.ageError < 10 ? 'Good' :
                                    ground_truth.ageError < 15 ? 'Moderate' : 'Poor';
            
            document.getElementById('ageAccuracy').className = `accuracy-badge ${ageAccuracyClass}`;
            document.getElementById('ageAccuracy').textContent = ageAccuracyText;

            const emotionAccuracyClass = ground_truth.emotionMatch ? 'accuracy-excellent' : 'accuracy-poor';
            const emotionAccuracyText = ground_truth.emotionMatch ? 'Correct' : 'Incorrect';
            
            document.getElementById('emotionAccuracy').className = `accuracy-badge ${emotionAccuracyClass}`;
            document.getElementById('emotionAccuracy').textContent = emotionAccuracyText;

            if (ground_truth.stressError !== null) {
                const stressAccuracyClass = ground_truth.stressError < 10 ? 'accuracy-excellent' :
                                           ground_truth.stressError < 20 ? 'accuracy-good' :
                                           ground_truth.stressError < 30 ? 'accuracy-moderate' : 'accuracy-poor';
                const stressAccuracyText = ground_truth.stressError < 10 ? 'Excellent' :
                                          ground_truth.stressError < 20 ? 'Good' :
                                          ground_truth.stressError < 30 ? 'Moderate' : 'Poor';
                
                document.getElementById('stressAccuracy').className = `accuracy-badge ${stressAccuracyClass}`;
                document.getElementById('stressAccuracy').textContent = stressAccuracyText;
            } else {
                document.getElementById('stressAccuracy').className = 'accuracy-badge accuracy-moderate';
                document.getElementById('stressAccuracy').textContent = 'N/A';
            }
        }

        function addToHistory(test) {
            testHistory.unshift(test);
            
            const historyList = document.getElementById('historyList');
            const historySection = document.getElementById('testHistory');
            
            historySection.style.display = 'block';
            
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <strong>${test.filename}</strong> - ${test.timestamp}<br>
                Age: ${test.actualAge} ‚Üí ${test.predictedAge} (Error: ¬±${test.ageError}, Confidence: ${(test.ageConfidence * 100).toFixed(0)}%)<br>
                Emotion: ${test.emotionMatch ? '‚úÖ Match' : '‚ùå Mismatch'}
            `;
            
            historyList.insertBefore(item, historyList.firstChild);
        }

        function clearHistory() {
            testHistory = [];
            document.getElementById('historyList').innerHTML = '';
            document.getElementById('testHistory').style.display = 'none';
        }
    </script>
</body>
</html>
